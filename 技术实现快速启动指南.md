# 深渊巢穴 - 技术实现快速启动指南

## 项目初始化清单

### 1. 开发环境搭建

#### 必需软件
```bash
# 客户端开发
- Unity 2022.3 LTS
- Visual Studio 2022 / JetBrains Rider
- Git (版本控制)

# 服务端开发  
- Node.js 18+ 
- Docker Desktop
- PostgreSQL 15+
- Redis 7+
- Postman (API测试)

# 开发工具
- VS Code
- DBeaver (数据库管理)
- Figma (UI设计)
```

#### 项目结构
```
DeepAbyssHive/
├── client/                 # Unity客户端
│   ├── Assets/
│   ├── Packages/
│   └── ProjectSettings/
├── server/                 # Node.js服务端
│   ├── src/
│   ├── tests/
│   ├── docker/
│   └── docs/
├── shared/                 # 共享代码
│   ├── protocols/
│   └── constants/
├── tools/                  # 开发工具
│   ├── data-generator/
│   └── balance-calculator/
└── docs/                   # 项目文档
    ├── api/
    ├── design/
    └── deployment/
```

### 2. 核心技术栈配置

#### 服务端技术栈
```json
// package.json
{
  "name": "deep-abyss-hive-server",
  "version": "1.0.0",
  "dependencies": {
    "express": "^4.18.2",
    "typescript": "^5.0.0",
    "prisma": "^5.0.0",
    "redis": "^4.6.0",
    "socket.io": "^4.7.0",
    "jsonwebtoken": "^9.0.0",
    "bcryptjs": "^2.4.3",
    "joi": "^17.9.0",
    "winston": "^3.10.0"
  }
}
```

#### 数据库配置
```sql
-- 初始化脚本 init.sql
CREATE DATABASE deep_abyss_hive;
CREATE USER dah_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE deep_abyss_hive TO dah_user;

-- 扩展安装
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
```

### 3. 核心系统实现模板

#### 基因系统核心类
```typescript
// src/systems/GeneSystem.ts
export class GeneSystem {
  private geneRepository: GeneRepository;
  private aiService: AIService;

  constructor() {
    this.geneRepository = new GeneRepository();
    this.aiService = new AIService();
  }

  async fuseGenes(geneIds: string[], playerId: string): Promise<FusionResult> {
    // 验证基因有效性
    const genes = await this.geneRepository.findByIds(geneIds);
    if (genes.length !== geneIds.length) {
      throw new Error('Invalid genes provided');
    }

    // 计算融合结果
    const fusionResult = await this.calculateFusion(genes);
    
    // 检查突变概率
    const mutationChance = this.calculateMutationChance(genes);
    if (Math.random() < mutationChance) {
      fusionResult.mutation = await this.aiService.generateMutation(genes);
    }

    // 保存结果
    await this.geneRepository.saveFusionResult(playerId, fusionResult);
    
    return fusionResult;
  }

  private async calculateFusion(genes: Gene[]): Promise<FusionResult> {
    // 基因融合算法实现
    const baseStats = genes.reduce((acc, gene) => {
      return this.mergeGeneEffects(acc, gene.effects);
    }, {});

    return {
      resultGene: {
        id: uuidv4(),
        sequence: this.generateSequence(genes),
        effects: baseStats,
        rarity: this.calculateRarity(genes),
        parents: genes.map(g => g.id)
      }
    };
  }
}
```

#### 母巢系统核心类
```typescript
// src/systems/HiveSystem.ts
export class HiveSystem {
  private hiveRepository: HiveRepository;
  private resourceService: ResourceService;

  async upgradeHive(hiveId: string, playerId: string): Promise<UpgradeResult> {
    const hive = await this.hiveRepository.findById(hiveId);
    if (hive.playerId !== playerId) {
      throw new Error('Unauthorized');
    }

    // 检查升级条件
    const upgradeCost = this.calculateUpgradeCost(hive.level);
    const playerResources = await this.resourceService.getPlayerResources(playerId);
    
    if (!this.canAffordUpgrade(playerResources, upgradeCost)) {
      throw new Error('Insufficient resources');
    }

    // 执行升级
    await this.resourceService.consumeResources(playerId, upgradeCost);
    const upgradedHive = await this.hiveRepository.upgrade(hiveId);
    
    // 扩展菌毯
    await this.expandCreep(hiveId, upgradedHive.level);

    return {
      hive: upgradedHive,
      newUnlocks: this.getUnlocksForLevel(upgradedHive.level)
    };
  }

  private async expandCreep(hiveId: string, level: number): Promise<void> {
    const expansionRadius = level * 2; // 每级扩展2格
    await this.hiveRepository.updateCreepArea(hiveId, expansionRadius);
  }
}
```

### 4. API路由设计

#### 基础路由结构
```typescript
// src/routes/index.ts
import express from 'express';
import { authRoutes } from './auth';
import { gameRoutes } from './game';
import { geneRoutes } from './genes';
import { marketRoutes } from './market';

const router = express.Router();

router.use('/auth', authRoutes);
router.use('/game', gameRoutes);
router.use('/genes', geneRoutes);
router.use('/market', marketRoutes);

export { router as apiRoutes };
```

#### 基因系统API
```typescript
// src/routes/genes.ts
import { Router } from 'express';
import { GeneController } from '../controllers/GeneController';
import { authMiddleware } from '../middleware/auth';

const router = Router();
const geneController = new GeneController();

router.use(authMiddleware);

router.get('/', geneController.getPlayerGenes);
router.post('/fuse', geneController.fuseGenes);
router.post('/extract', geneController.extractGene);
router.get('/recipes', geneController.getRecipes);

export { router as geneRoutes };
```

### 5. Unity客户端核心架构

#### 游戏管理器
```csharp
// Assets/Scripts/Core/GameManager.cs
using UnityEngine;
using System.Collections.Generic;

public class GameManager : MonoBehaviour
{
    public static GameManager Instance { get; private set; }
    
    [Header("Systems")]
    public HiveSystem hiveSystem;
    public GeneSystem geneSystem;
    public UnitSystem unitSystem;
    public ResourceSystem resourceSystem;
    
    private NetworkManager networkManager;
    private UIManager uiManager;
    
    void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
            InitializeSystems();
        }
        else
        {
            Destroy(gameObject);
        }
    }
    
    private void InitializeSystems()
    {
        networkManager = GetComponent<NetworkManager>();
        uiManager = FindObjectOfType<UIManager>();
        
        // 初始化各个系统
        hiveSystem.Initialize();
        geneSystem.Initialize();
        unitSystem.Initialize();
        resourceSystem.Initialize();
        
        // 建立系统间通信
        SetupSystemCommunication();
    }
    
    private void SetupSystemCommunication()
    {
        // 资源变化事件
        resourceSystem.OnResourceChanged += uiManager.UpdateResourceDisplay;
        
        // 基因融合事件
        geneSystem.OnGeneFused += (result) => {
            uiManager.ShowFusionResult(result);
            if (result.HasMutation)
            {
                uiManager.ShowMutationNotification(result.Mutation);
            }
        };
        
        // 单位孵化事件
        unitSystem.OnUnitHatched += (unit) => {
            uiManager.ShowUnitHatchedNotification(unit);
        };
    }
}
```

#### 基因系统客户端
```csharp
// Assets/Scripts/Systems/GeneSystem.cs
using UnityEngine;
using System.Collections.Generic;
using System.Threading.Tasks;

public class GeneSystem : MonoBehaviour
{
    [Header("Gene Database")]
    public GeneDatabase geneDatabase;
    
    private List<Gene> playerGenes = new List<Gene>();
    private GeneLabUI geneLabUI;
    
    public event System.Action<FusionResult> OnGeneFused;
    
    public void Initialize()
    {
        geneLabUI = FindObjectOfType<GeneLabUI>();
        LoadPlayerGenes();
    }
    
    public async Task<FusionResult> FuseGenes(List<Gene> genes)
    {
        // 发送融合请求到服务器
        var request = new GeneFusionRequest
        {
            GeneIds = genes.ConvertAll(g => g.Id),
            PlayerId = PlayerData.Instance.PlayerId
        };
        
        var result = await NetworkManager.Instance.SendRequest<FusionResult>(
            "/api/genes/fuse", request);
        
        if (result.Success)
        {
            // 更新本地基因库
            UpdateLocalGenes(result.Data);
            OnGeneFused?.Invoke(result.Data);
        }
        
        return result.Data;
    }
    
    private void UpdateLocalGenes(FusionResult result)
    {
        // 移除消耗的基因
        foreach (var parentId in result.ResultGene.Parents)
        {
            playerGenes.RemoveAll(g => g.Id == parentId);
        }
        
        // 添加新基因
        playerGenes.Add(result.ResultGene);
        
        // 更新UI
        geneLabUI.RefreshGeneList(playerGenes);
    }
}
```

### 6. 开发流程建议

#### 第一周：环境搭建
1. 搭建开发环境
2. 创建项目结构
3. 配置数据库
4. 实现基础认证系统

#### 第二周：核心系统框架
1. 实现基础的母巢系统
2. 创建简单的资源管理
3. 搭建基础UI框架
4. 实现客户端-服务器通信

#### 第三周：基因系统原型
1. 实现基因数据模型
2. 创建基础融合算法
3. 搭建基因实验室UI
4. 测试基因融合功能

#### 第四周：集成测试
1. 系统集成测试
2. 性能优化
3. Bug修复
4. 准备演示版本

### 7. 关键配置文件

#### Docker配置
```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: deep_abyss_hive
      POSTGRES_USER: dah_user
      POSTGRES_PASSWORD: secure_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  server:
    build: ./server
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - redis
    environment:
      DATABASE_URL: postgresql://dah_user:secure_password@postgres:5432/deep_abyss_hive
      REDIS_URL: redis://redis:6379

volumes:
  postgres_data:
  redis_data:
```

#### 环境变量配置
```env
# .env
NODE_ENV=development
PORT=3000
DATABASE_URL=postgresql://dah_user:secure_password@localhost:5432/deep_abyss_hive
REDIS_URL=redis://localhost:6379
JWT_SECRET=your_jwt_secret_here
OPENAI_API_KEY=your_openai_key_here
```

这个快速启动指南提供了项目开发的技术基础，开发团队可以基于这些模板快速搭建项目框架并开始核心功能的开发。

---

**文档状态**: 技术实现指南  
**适用阶段**: 项目启动期  
**更新频率**: 根据开发进展调整